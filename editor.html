<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ProBuild - Editor</title>
  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üõ†Ô∏è</text></svg>">
  <!-- Preconnect to Google Fonts for faster loading -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <!-- Google Fonts - Add Roboto Mono for code editor -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <!-- CSS -->
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/editor.css">
  <link rel="stylesheet" href="css/dialog.css">
  <link rel="stylesheet" href="css/notifications.css">
  <link rel="stylesheet" href="css/component-preview.css">
  <link rel="stylesheet" href="css/blocks-editor.css">
  <link rel="stylesheet" href="css/code-editor.css">
  <link rel="stylesheet" href="css/build-manager.css">
  <!-- Blockly Core via CDN - Updated sources -->
  <script src="https://cdn.jsdelivr.net/npm/blockly@9.3.3/blockly_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blockly@9.3.3/blocks_compressed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/blockly@9.3.3/javascript_compressed.js"></script>
  <!-- English Language File -->
  <script src="https://cdn.jsdelivr.net/npm/blockly@9.3.3/msg/en.js"></script>
  
  <!-- Prevent undefined resource errors before page load -->
  <script>
    // Explicitly prevent known undefined resource errors
    (function() {
      // Intercept all resource loading
      const originalCreateElement = document.createElement;
      document.createElement = function(tagName) {
        const element = originalCreateElement.call(document, tagName);
        
        // Only for resource elements
        if (tagName.toLowerCase() === 'img' || tagName.toLowerCase() === 'script' || tagName.toLowerCase() === 'link') {
          // Override setter for src/href to prevent undefined
          const originalSrcSetter = Object.getOwnPropertyDescriptor(element.__proto__, 'src');
          const originalHrefSetter = Object.getOwnPropertyDescriptor(element.__proto__, 'href');
          
          if (originalSrcSetter && originalSrcSetter.set) {
            Object.defineProperty(element, 'src', {
              set: function(value) {
                if (!value || value === 'undefined' || value.includes('/undefined')) {
                  console.warn('Prevented setting undefined src', value);
                  if (tagName.toLowerCase() === 'img') {
                    // Set blank image instead
                    originalSrcSetter.set.call(this, 'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==');
                  }
                  return;
                }
                originalSrcSetter.set.call(this, value);
              },
              get: originalSrcSetter.get
            });
          }
          
          if (originalHrefSetter && originalHrefSetter.set) {
            Object.defineProperty(element, 'href', {
              set: function(value) {
                if (!value || value === 'undefined' || value.includes('/undefined')) {
                  console.warn('Prevented setting undefined href', value);
                  return;
                }
                originalHrefSetter.set.call(this, value);
              },
              get: originalHrefSetter.get
            });
          }
        }
        
        return element;
      };
    })();
  </script>
  
  <!-- Verify Blockly is loaded -->
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      // Check if we're running on GitHub Pages
      const isGitHubPages = window.location.hostname.includes('github.io');
      console.log(`Running on GitHub Pages: ${isGitHubPages}`);

      if (typeof Blockly === 'undefined') {
        console.error('Blockly failed to load. Please check your internet connection or try reloading the page.');
        alert('Error: Blockly library failed to load properly. The app may not function correctly.');
        
        // If on GitHub Pages, try to reload the scripts
        if (isGitHubPages) {
          console.log('Attempting to reload Blockly scripts for GitHub Pages...');
          const scripts = [
            'https://cdn.jsdelivr.net/npm/blockly@9.3.3/blockly_compressed.js',
            'https://cdn.jsdelivr.net/npm/blockly@9.3.3/blocks_compressed.js',
            'https://cdn.jsdelivr.net/npm/blockly@9.3.3/javascript_compressed.js',
            'https://cdn.jsdelivr.net/npm/blockly@9.3.3/msg/en.js'
          ];
          
          // Load scripts sequentially
          let loadNextScript = function(index) {
            if (index >= scripts.length) return;
            
            const script = document.createElement('script');
            script.src = scripts[index];
            script.onload = function() {
              console.log(`Loaded ${scripts[index]}`);
              loadNextScript(index + 1);
            };
            script.onerror = function() {
              console.error(`Failed to load ${scripts[index]}`);
              loadNextScript(index + 1);
            };
            document.head.appendChild(script);
          };
          
          loadNextScript(0);
        }
      } else {
        console.log('Blockly successfully loaded:', Blockly.VERSION);
      }
      
      // Pre-create a blockly-div in the body as a fallback
      if (isGitHubPages) {
        // Create a hidden blockly container that can be used as a fallback
        const fallbackContainer = document.createElement('div');
        fallbackContainer.id = 'blockly-fallback-container';
        fallbackContainer.style.position = 'absolute';
        fallbackContainer.style.top = '-9999px';
        fallbackContainer.style.left = '-9999px';
        fallbackContainer.style.width = '800px';
        fallbackContainer.style.height = '600px';
        fallbackContainer.innerHTML = '<div id="blockly-div-fallback" style="width:100%; height:100%;"></div>';
        document.body.appendChild(fallbackContainer);
        console.log('Created fallback blockly container for GitHub Pages');
      }
      
      // Handle undefined URLs causing 404 errors
      window.addEventListener('error', function(e) {
        console.log('Error event detected:', e.type);
        const target = e.target;
        // Check if it's a resource load error
        if (target && (target.nodeName === 'IMG' || target.nodeName === 'SCRIPT' || target.nodeName === 'LINK')) {
          const url = target.src || target.href;
          console.log('Resource error with URL:', url);
          
          if (!url || url === 'undefined' || url.includes('undefined') || url.endsWith('/undefined')) {
            console.warn('Prevented load of resource with undefined URL:', url);
            e.preventDefault();
            e.stopPropagation();
            // Fix the element
            if (target.nodeName === 'IMG') {
              target.src = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=';
            }
            return true;
          }
        }
      }, true);
      
      // Also capture unhandled promise rejections that might be related to resource loading
      window.addEventListener('unhandledrejection', function(e) {
        console.warn('Unhandled promise rejection:', e.reason);
      });
    });
  </script>
</head>
<body>
  <!-- Content will be dynamically generated by JavaScript -->
  
  <div id="app-root"></div>
  
  <script type="module">
    import EditorView from './js/editor/EditorView.js';
    
    document.addEventListener('DOMContentLoaded', () => {
      new EditorView();
    });
  </script>
</body>
</html> 